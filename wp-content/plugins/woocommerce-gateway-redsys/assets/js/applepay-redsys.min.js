function stringToHex(e){for(var o="",a=0;a<e.length;a++)o+=e.charCodeAt(a).toString(16).padStart(2,"0");return o}function onApplePayClicked(){if(console.log("Botón de Apple Pay clickeado."),ApplePaySession){var e={countryCode:VarcountryCode,currencyCode:VarcurrencyCode,supportedNetworks:["visa","masterCard","amex","discover"],merchantCapabilities:["supports3DS"],total:{label:VarmerchantName,amount:cartTotal}};console.log("Configuración de la solicitud de Apple Pay:",e);var o=new ApplePaySession(3,e);o.begin(),console.log("ApplePaySession iniciado."),o.onvalidatemerchant=function(e){console.log("Evento onvalidatemerchant recibido:",e),fetch(apple_redsys.ajax_url,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"action=validate_merchant&validationURL="+encodeURIComponent(e.validationURL)+"&nonce="+apple_redsys.nonce}).then(function(e){if(console.log("Respuesta de validate_merchant fetch:",e),!e.ok)throw new Error("Network response was not ok");return e.json()}).then(function(e){console.log("Merchant Session recibido:",e),e.success&&e.data?(o.completeMerchantValidation(e.data),console.log("Validación del comerciante completada.")):console.error("Error en la validación del comerciante:",e)}).catch(function(e){console.error("Merchant Validation Error:",e)})},o.onpaymentmethodselected=function(e){console.log("Evento onpaymentmethodselected recibido:",e);var a={newTotal:{label:VarmerchantName,type:"final",amount:cartTotal}};o.completePaymentMethodSelection(a),console.log("Pago actualizado con el nuevo monto:",a)},o.onpaymentauthorized=function(e){console.log("Evento onpaymentauthorized recibido:",e);var a=Math.random().toString(36).substring(2,11)+"_applepay";console.log("Referencia única generada para el pago:",a);var n=document.getElementById("apple-referencia-redsys");n?(n.value=a,console.log('Valor asignado al campo "apple-referencia-redsys":',n.value)):console.error('No se encontró el elemento con ID "apple-referencia-redsys".');var t=e.payment.token.paymentData;console.log("Datos de pago de Apple Pay:",t);var r=JSON.stringify(t),l=stringToHex(r);console.log("Datos de pago convertidos a Hex:",l);var c=document.getElementById("apple-token-redsys");c?(c.value=l,console.log('Valor asignado al campo "apple-token-redsys":',c.value)):console.error('No se encontró el elemento con ID "apple-token-redsys".'),console.log("Guardando datos y haciendo clic en el botón de pagar."),document.getElementById("place_order").click(),o.completePayment(ApplePaySession.STATUS_SUCCESS),console.log("Autorización del pago completada con éxito.")},o.oncancel=function(e){console.log("Pago cancelado por el usuario:",e)}}else console.error("ApplePaySession no está disponible en este navegador.")}var VarmerchantId=apple_redsys.merchantId,VarmerchantName=apple_redsys.merchantName,VarcountryCode=apple_redsys.countryCode,VarcurrencyCode=apple_redsys.currencyCode,url_site=apple_redsys.url_site,cartTotal=apple_redsys.cart_total;document.addEventListener("DOMContentLoaded",function(){console.log("DOM completamente cargado y parseado.");var e=document.querySelector("#apple-pay-button");e?(e.addEventListener("click",onApplePayClicked),console.log("Listener para el botón de Apple Pay añadido.")):console.warn("No se encontró el botón de Apple Pay en el DOM.")});