function stringToHex(e){for(var o="",a=0;a<e.length;a++)o+=e.charCodeAt(a).toString(16).padStart(2,"0");return o}function onApplePayClicked(){function e(e,o){console.log("Iniciando pay_order con referencia:",e);const{CHECKOUT_STORE_KEY:a}=window.wc.wcBlocksData,n=wp.data.select(a),t=n.getOrderId();console.log("Order ID obtenido del store para pay_order:",t),jQuery.ajax({url:apple_redsys.ajax_url,type:"POST",data:{action:"pay_order_applepay",apple_referencia_redsys:e,order_id:t,nonce:apple_redsys.nonce},success:function(e){console.log("Respuesta del servidor para pay_order:",e),e&&e.success?(o.completePayment(ApplePaySession.STATUS_SUCCESS),window.location.href=e.data.redirect):(console.error("Error en la respuesta de pay_order:",e),o.completePayment(ApplePaySession.STATUS_FAILURE))},error:function(e){console.error("Error en pay_order:",e),o.completePayment(ApplePaySession.STATUS_FAILURE)}})}function o(){return console.log("Iniciando getAppleTransactionInfo"),new Promise((e,o)=>{jQuery.ajax({url:url_site+"/?wc-api=WC_Gateway_applepayredsys&checkout-price=true",method:"GET",dataType:"json",success:function(a){console.log("Respuesta del servidor para getAppleTransactionInfo:",a),a&&a.total?(console.log("Total obtenido del carrito:",a.total),e(a.total)):(console.error("No se pudo obtener el total del carrito. Respuesta del servidor:",a),o(new Error("No se pudo obtener el total del carrito")))},error:function(e){console.error("Error al obtener la información de la transacción de Apple Pay:",e),o(e)}})})}if(console.log("Botón de Apple Pay clickeado."),ApplePaySession){var a="0.00",n={countryCode:VarcountryCode,currencyCode:VarcurrencyCode,supportedNetworks:["visa","masterCard","amex","discover"],merchantCapabilities:["supports3DS"],requiredShippingContactFields:["postalAddress","name","phone","email"],requiredBillingContactFields:["postalAddress","name","phone","email"],total:{label:VarmerchantName,amount:a}};console.log("Creando ApplePaySession con request:",n);var t=new ApplePaySession(3,n);t.begin(),console.log("ApplePaySession iniciado."),t.onshippingcontactselected=function(e){console.log("El evento onshippingcontactselected se está ejecutando"),console.log("Datos de shippingContact:",e.shippingContact),console.log("Evento completo:",e);const o=e.shippingContact,{administrativeArea:a,locality:n,postalCode:r,countryCode:l}=o,{CHECKOUT_STORE_KEY:s}=window.wc.wcBlocksData,c=wp.data.select(s),i=c.getOrderId();console.log("Order ID obtenido del store:",i);const d={action:"redsys_update_checkout_address",nonce:nonce,state:a,city:n,postcode:r,country:l,order_id:i};console.log("Datos de envío preparados para AJAX:",d),jQuery.ajax({url:apple_redsys.ajax_url,type:"POST",data:d,success:function(e){if(console.log("shippingData success"),console.log("Respuesta completa del servidor:",e),e.success){const o=[{label:"Virtual Delivery",detail:"Delivered electronically",amount:"0.00",identifier:"virtual-delivery"}],a={label:VarmerchantName,amount:String(e.data.total),type:"final"};console.log("newTotal:",JSON.stringify(a,null,2));const n=[];t.completeShippingContactSelection(ApplePaySession.STATUS_SUCCESS,o,a,n)}else console.error("Error en la respuesta del servidor:",e),t.completeShippingContactSelection(ApplePaySession.STATUS_FAILURE)},error:function(e){console.error("Error al actualizar la dirección de envío:",e),t.completeShippingContactSelection(ApplePaySession.STATUS_FAILURE)}})},t.onvalidatemerchant=function(e){console.log("Evento onvalidatemerchant recibido:",e),fetch(apple_redsys.ajax_url,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"action=validate_merchant&validationURL="+encodeURIComponent(e.validationURL)+"&nonce="+encodeURIComponent(nonce)}).then(function(e){if(console.log("Respuesta del servidor para validación del comerciante:",e),!e.ok)throw new Error("Network response was not ok");return e.json()}).then(function(e){console.log("Merchant Session recibido:",e),e.success&&e.data?(t.completeMerchantValidation(e.data),console.log("Validación del comerciante completada.")):(console.error("Error en la validación del comerciante:",e),t.completeMerchantValidation())}).catch(function(e){console.error("Merchant Validation Error:",e),t.completeMerchantValidation()})},t.onpaymentmethodselected=function(e){console.log("Evento onpaymentmethodselected recibido:",e),o().then(function(e){const o={newTotal:{label:VarmerchantName,type:"final",amount:e}};t.completePaymentMethodSelection(o),console.log("Pago actualizado con el nuevo monto:",o)}).catch(function(e){console.error("Error obteniendo el total del carrito:",e),t.completePaymentMethodSelection({newTotal:{label:VarmerchantName,type:"final",amount:"0.00"}})})},t.onpaymentauthorized=function(o){console.log("Evento onpaymentauthorized recibido:",o);const{CHECKOUT_STORE_KEY:a}=window.wc.wcBlocksData,n=wp.data.select(a),r=n.getOrderId();console.log("Order ID obtenido del store para pago autorizado:",r);var l=o.payment.shippingContact,s=o.payment.billingContact,c=o.payment.token.paymentData,i=JSON.stringify(c),d=stringToHex(i);console.log("Datos de pago convertidos a Hex:",d);var p=Math.random().toString(36).substring(2,11)+"_applepay";console.log("Referencia única generada para el pago:",p);const u={first_name:l.givenName||"",last_name:l.familyName||"",email:l.emailAddress||"",phone:l.phoneNumber||"",address_1:l.addressLines[0]||"",address_2:l.addressLines.length>1?l.addressLines.slice(1).join(", "):"",city:l.locality||"",state:l.administrativeArea||"",postcode:l.postalCode||"",country:l.countryCode||""},y={first_name:s.givenName||"",last_name:s.familyName||"",email:s.emailAddress||"",phone:s.phoneNumber||"",address_1:s.addressLines[0]||"",address_2:s.addressLines.length>1?s.addressLines.slice(1).join(", "):"",city:s.locality||"",state:s.administrativeArea||"",postcode:s.postalCode||"",country:s.countryCode||""};console.log("Datos de envío:",u),console.log("Datos de facturación:",y);var m={action:"save_all_order_data_applepay",order_id:r,shippingData:u,billingData:y,nonce:nonce,apple_referencia_redsys:p,apple_token_redsys:d};jQuery.ajax({url:apple_redsys.ajax_url,type:"POST",data:m,success:function(o){console.log("Datos enviados con éxito:",o),o.success?e(p,t):(console.error("Error al guardar los datos del pedido:",o),t.completePayment(ApplePaySession.STATUS_FAILURE))},error:function(e){console.error("Error al enviar los datos:",e),t.completePayment(ApplePaySession.STATUS_FAILURE)}})},document.addEventListener("DOMContentLoaded",function(){console.log("DOM completamente cargado y parseado.");var e=document.querySelector("#apple-pay-button");e?(e.addEventListener("click",onApplePayClicked),console.log("Listener para el botón de Apple Pay añadido.")):console.warn("No se encontró el botón de Apple Pay en el DOM.")})}else console.error("ApplePaySession no está disponible en este navegador.")}var VarmerchantId=apple_redsys.merchantId,VarmerchantName=apple_redsys.merchantName,VarcountryCode=apple_redsys.countryCode,VarcurrencyCode=apple_redsys.currencyCode,url_site=apple_redsys.url_site,nonce=apple_redsys.nonce;